# Maintainer: TheKit <nekit1000@gmail.com>

pkgname=libhybris
pkgver=1.0_git20220208
pkgrel=0
arch="armhf armv7 aarch64"
url="https://github.com/libhybris/libhybris"
license="Apache-2.0"
pkgdesc="libhybris allows to use bionic-based HW adaptations"
_commit="fa2bb0c4188a88ba026c59e9179c8a83a447898f"
makedepends="autoconf automake libtool wayland-dev linux-headers bsd-compat-headers
	libx11-dev libxcb-dev libxext-dev android-headers"
source="$pkgname-$_commit.tar.gz::https://github.com/manjaro-libhybris/libhybris/archive/$_commit.tar.gz
	0001-Make-libhybris-compile-with-musl.patch
	0002-Make-libhybris-compile-with-musl.patch"

options="!check !strip !tracedeps"

builddir="$srcdir/$pkgname-$_commit"

build() {
  cd "$builddir"/hybris

  ./autogen.sh \
    --prefix=/usr \
    --enable-wayland \
    --enable-trace \
    --enable-debug \
    --enable-experimental \
    --with-android-headers=/usr/include/android \
    --enable-arch=arm64 \
    --with-default-hybris-ld-library-path=/usr/libexec/droid-hybris/system/lib64:/system/lib64:/vendor/lib64 \
    --enable-property-cache \
    --enable-glvnd
  make
}

package() {
  cd "$builddir"/hybris

  # lib dependency issue: workaround with -j1
  make -j1 DESTDIR="${pkgdir}" install

  rm -f ${pkgdir}/usr/lib/pkgconfig/{egl,glesv1_cm,glesv2,wayland-egl}.pc

  cd "${pkgdir}/usr/include"
  # Move libhybris-provided headers into hybris dir
  mv CL EGL GLES GLES2 GLES3 KHR VG hybris

  # Symlink eglhybris.h
  mkdir -p EGL
  cd EGL
  ln -s ../hybris/EGL/eglhybris.h .
}
sha512sums="
8f020d3f6487ad32676cedf3861c68676c11f09d839f248a6ac914b7091e52026cadbc7877d9d87939255a6125a22fbdc97efceef8bac4fb4d77fdc7d8ec8f30  libhybris-fa2bb0c4188a88ba026c59e9179c8a83a447898f.tar.gz
c19ac8492d3f8d735fe41463c5d28e2264866288f21e0e5facb26d89a76ac9d32d5939813c8d421acdd4474819ed8c7ee138edbde54fc86f8d296959042e2d13  0001-Make-libhybris-compile-with-musl.patch
2dbb72f591afb8283d641408994d2080b299b589ecdabfebc5af4057a577112569ac879204f112b82b1dbec9744238010bfe6e15e4a1af60d38474c293e36f2c  0002-Make-libhybris-compile-with-musl.patch
"
